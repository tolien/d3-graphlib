<html>
<link rel="stylesheet" type="text/css" href="d3chart.css" />
<style>

body {
  font: 10px sans-serif;
}

</style>
<body>
	<script src="d3.js" charset="utf-8"></script>
	<script src="d3chart.js" charset="utf-8"></script>
	

	<script>

		margin = {top: 20, right: 80, bottom: 30, left: 50};
		width = 960 - margin.left - margin.right;
	    height = 500 - margin.top - margin.bottom;
	setup();
	d3.selectAll('svg').attr('class', 'power');
	
	// date parser - will convert YYYYMMDD dates into JS Date objects
	var parseDate = d3.time.format("%Y%m%d").parse;

			// a line object
	var line = d3.svg.line()
	    .interpolate("monotone")
	    .x(function(d) { return x(d.date); })
	    .y(function(d) { return y(d.power); });

var formatValue = function(s) {
    return s.toFixed(0);
    }
    			
			d3.select('.y.axis text').attr("dy", ".71em").text("Power (W)");
			

			// load the JSON data
			// at this point, data looks like 
			// power: [ data: [ [ timestamp, power ]...[ timestamp, power] ], period: date range ]
var doStuff = function(error, data) {
	  if (error) {
	    console.log(error);
	    return;
	  }
	  color.domain(d3.keys(data));
 
		// so we extract the list of timestamp/value pairs
		data = data.power[0].data
		
		// ... and convert the timestamp into a JS Date object
	  data.forEach(function(d) {
	    d[0] = new Date(d[0]);
	  });

	  var cities = color.domain().map(function(name) {
	    return {
	      name: name,
	      values: data.map(function(d) {
	        return {date: d[0], power: +d[1], series: name};
	      })
	    };
	  });
		
		var t0 = d3.select('.power');
		if (!t0.select('g.grapharea').empty()) {
	    	t0.select('g.grapharea').data(cities);
	    }
	    else {
	        svg.append("g")
			    .data(cities)
				.attr("class", "grapharea");
		}
			updatePowerChart(t0, d3.select('.power'));

	};
	
function update_data() {
	d3.timer(update_data, 5 * 60 * 1000);
	console.log("update_data fired at " + new Date().toString());
	d3.json("http://data.tolien.co.uk/power/data.json", doStuff);
	
	return true;
}

update_data();


	</script>
</body>

</html>
