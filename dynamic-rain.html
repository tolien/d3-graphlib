<html>
<link rel="stylesheet" type="text/css" href="d3chart.css" />
<style>

body {
  font-family: sans-serif;
  font-size: smaller;
}

</style>
<body>
	<script src="d3.js" charset="utf-8"></script>
	<script src="d3chart.js" charset="utf-8"></script>
	

	<script>

	setup();
	d3.selectAll('svg').attr('class', 'rain');

	d3.select('.y.axis text').text("Precipitation (mm)");

var doStuff = function(error, allData) {
	if (error) {
		console.log(error);
		return;
	}

	color.domain(["rain"]);
	// so we extract the list of timestamp/value pairs
	data = allData.rain.total.data;


	// ... and convert the timestamp into a JS Date object
	data.forEach(function(d) {
		d[0] = new Date(d[0]);
	});

	if (data.length > 0) {
		barWidth = width / data.length;
	} else {
		barWidth = width;
	}
	console.log("Bar width " + barWidth);

	var rainData = color.domain().map(function(name) {
		return {
		        values: data.map(function(d) {
		            return { date: d[0], value: +d[1].toFixed(1) }
		        }),
				name: name
			};
		});
	
	var rain = svg.selectAll(".rain")
		.data(rainData, function (d) { return d.date; })
		.enter().append("g")
		.attr("class", "grapharea");
		
	updateRainChart(null, d3.select('.rain'));
};

// load the JSON data
// at this point, data looks like 
// value: [ data: [ [ timestamp, value ]...[ timestamp, value] ], period: date range ]
var update_data = function() {
    d3.timer(update_data, 5 * 60 * 1000);
    console.log("update_data fired at " + new Date().toString());
    // load the JSON data
    // and when that's finished, called the function defined in doStuff
    d3.json("http://weather.tolien.co.uk/month-data.json", doStuff);

    return true;
}

update_data();

function force_update() {
    update_data();
}

function old_force_update() {
	var points = d3.select('g.rain');
	var data = points.data();
	var removed = data[0][0];
	var deltaT = (data[0][1].date.getTime() - removed.date.getTime()) * data[0].length;
	var cloneDate = new Date(removed.date.getTime() + deltaT);
	data[0].push({
		date: cloneDate,
		value: removed.value,
		series: removed.series
	});

	data[0].shift();
	
	points.data(data);

	var div = d3.select("body").append("div")
		.attr("class", "tooltip")
		.style("opacity", 0);

updateRainChart();		
		


}
	</script>
	
	<input type="button" onclick="force_update()" value="Update" />
</body>

</html>
