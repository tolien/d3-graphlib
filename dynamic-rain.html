<html>
<link rel="stylesheet" type="text/css" href="d3chart.css" />
<style>

body {
  font-family: sans-serif;
  font-size: smaller;
}

</style>
<body>
	<script src="d3.js" charset="utf-8"></script>
	<script src="d3chart.js" charset="utf-8"></script>
	

	<script>

	setup();
	d3.selectAll('svg').attr('class', 'rain');

	d3.select('.y.axis text').text("Precipitation (mm)");

var div = d3.select("body").append("div")
	.attr("class", "tooltip")
	.style("opacity", 0);

var doStuff = function(error, allData) {
	if (error) {
		console.log(error);
		return;
	}

	color.domain(["rain"]);
	// so we extract the list of timestamp/value pairs
	data = allData.rain.total.data;


	// ... and convert the timestamp into a JS Date object
	data.forEach(function(d) {
		d[0] = new Date(d[0]);
	});

	if (data.length > 0) {
		barWidth = width / data.length;
	} else {
		barWidth = width;
	}
	console.log("Bar width " + barWidth);

	var cities = color.domain().map(function(name) {
		return data.map(function(d) {
		    return {
				date: d[0],
				power: +d[1].toFixed(1),
				series: name
			}
		});
	});
	
	var city = svg.selectAll(".city")
		.data(cities, function (d) { return d.date; })
		.enter().append("g")
		.attr("class", "city");

	var point = city.selectAll(".bar")
		.data(function(d) {
			return d;
		}, function(d) { return d.date} )
		.enter().append("rect")
		.attr("class", "bar")
		.attr("fill", function(d, i) {
			return color("rain")
		})
		.attr("x", function(d, i) {
			console.log(d.date + ", " + x(d.date));
			return x(d.date)
		})
		.attr("y", function(d, i) {
			return y(d.power)
		})
		.attr("width", barWidth)
		.attr("height", function(d) {
			return height - y(d.power);
		})
		.on("mouseover", function(d) {
			var parent = d3.select(this.parentElement).selectAll('.line');
			this.style.opacity = 1;
			div.transition()
				.duration(200)
				.style("opacity", .9)
				.style("border-color", color(d.series));
			div.html(formatTime(d.date) + "<br />" + d.power + " mm")
				.style("left", 5 + d3.event.pageX + "px")
				.style("top", (d3.event.pageY - 28) + "px");

		})
		.on("mouseout", function(d) {
			console.log("mouseout");
			this.style.opacity = 0.7;
			div.style('opacity', 0);
		})
};

// load the JSON data
// at this point, data looks like 
// power: [ data: [ [ timestamp, power ]...[ timestamp, power] ], period: date range ]
d3.json("http://weather.tolien.co.uk/month-data.json", doStuff);


function force_update() {
  var transitionTime = 0;
	var points = d3.select('.rain').select('.city');
	var data = points.data();
	var removed = data[0][0]
	var cloneDate = new Date(removed.date.getTime() + 24 * 60 * 60 * 1000);
	data[0].push({
		date: cloneDate,
		power: removed.power,
		series: removed.series
	});

	data[0].shift();

	var extent = d3.extent(data[0], function(d) {
		return d.date;
	});
	var endDate = new Date(extent[1]);
	endDate.setHours(endDate.getHours() + 1);
	extent[1] = endDate;
	x.domain(extent);

	d3.selectAll('.x.axis')
		.transition()
		.duration(transitionTime)
		.call(xAxis);

	d3.selectAll('.y.axis')
		.transition()
		.duration(transitionTime)
		.call(yAxis);
		
		var bars = points.selectAll('.bar')
		.data(function(d) {
			return d;
		}, function(d) { return d.date; });

	var div = d3.select("body").append("div")
		.attr("class", "tooltip")
		.style("opacity", 0);

        bars.enter().append("rect")
         .attr("class", "bar")
         .attr("fill", function(d, i) { return color(d.series) })
         .attr("x", function(d, i) { return x(d.date) })
         .attr("y", function(d, i) { return y(d.power) })
				 .attr("width", barWidth)
				 .attr("height", function(d) { return height - y(d.power); })
         .on("mouseover", function(d) {
            var parent = d3.select(this.parentElement).selectAll('.line');
            this.style.opacity = 1;
            div.transition()
            .duration(200)
            .style("opacity", .9)
            .style("border-color", color(d.series));
            div .html(formatTime(d.date) + "<br />" + d.power + " mm")
            .style("left", 5 + d3.event.pageX + "px")
            .style("top", (d3.event.pageY - 28) + "px");
            
        })
        .on("mouseout", function(d) {
            this.style('opacity', 0.9);
            div.style('opacity', 0);
        })
	

		bars
		.transition()
		.duration(transitionTime)
		.attr("x", function(d, i) {
			//console.log(d.date + ", " + x(d.date));
			return x(d.date)
		})
		.attr("y", function(d, i) {
			return y(d.power)
		})
		.attr("height", function(d) {
			return height - y(d.power);
		});
		
		bars.exit()
    		.transition(transitionTime)
	    	.remove();
		
		


}
	</script>
	
	<input type="button" onclick="force_update()" value="Update" />
</body>

</html>
