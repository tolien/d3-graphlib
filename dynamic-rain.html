<html>
<link rel="stylesheet" type="text/css" href="d3chart.css" />
<style>

body {
  font-family: sans-serif;
  font-size: smaller;
}

</style>
<body>
	<script src="d3.js" charset="utf-8"></script>
	<script src="d3chart.js" charset="utf-8"></script>
	

	<script>

	setup();
	d3.selectAll('svg').attr('class', 'rain');

	d3.select('.y.axis text').text("Precipitation (mm)");

var doStuff = function(error, allData) {
	if (error) {
		console.log(error);
		return;
	}

	color.domain(["rain"]);
	// so we extract the list of timestamp/value pairs
	data = allData.rain.total.data;


	// ... and convert the timestamp into a JS Date object
	data.forEach(function(d) {
		d[0] = new Date(d[0]);
	});

	if (data.length > 0) {
		barWidth = width / data.length;
	} else {
		barWidth = width;
	}
	console.log("Bar width " + barWidth);

	var rainData = color.domain().map(function(name) {
		return data.map(function(d) {
		    return {
				date: d[0],
				power: +d[1].toFixed(1),
				series: name
			}
		});
	});
	
	var rain = svg.selectAll(".rain")
		.data(rainData, function (d) { return d.date; })
		.enter().append("g")
		.attr("class", "rain");
		
	updateRainChart();
};

// load the JSON data
// at this point, data looks like 
// power: [ data: [ [ timestamp, power ]...[ timestamp, power] ], period: date range ]
d3.json("http://weather.tolien.co.uk/month-data.json", doStuff);


function force_update() {
	var points = d3.select('g.rain');
	var data = points.data();
	var removed = data[0][0];
	var deltaT = (data[0][1].date.getTime() - removed.date.getTime()) * data[0].length;
	var cloneDate = new Date(removed.date.getTime() + deltaT);
	data[0].push({
		date: cloneDate,
		power: removed.power,
		series: removed.series
	});

	data[0].shift();
	
	points.data(data);

	var div = d3.select("body").append("div")
		.attr("class", "tooltip")
		.style("opacity", 0);

updateRainChart();		
		


}
	</script>
	
	<input type="button" onclick="force_update()" value="Update" />
</body>

</html>
