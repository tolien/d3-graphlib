<html>
<link rel="stylesheet" type="text/css" href="d3chart.css" />
<style>

body {
  font-family: sans-serif;
  font-size: smaller;
}

</style>
<body>
	<script src="d3.js" charset="utf-8"></script>
	<script src="d3chart.js" charset="utf-8"></script>
	

	<script>
// a line object
var line = d3.svg.line()
	.interpolate("cardinal")
	.x(function(d) {
		return x(d.date);
	})
	.y(function(d) {
		return y(d.value);
	});
	
var formatValue = function(s) {
    return s.toFixed(1);
}

setup();
d3.selectAll('svg').attr('class', 'temp');

// and set up a clipping path - anything outside this region will not be drawn
// this is used as part of updating the chart
svg.append("defs").append("clipPath")
	.attr("id", "clip")
	.append("rect")
	.attr("width", width * 1.2)
	.attr("height", height);
	
	d3.select('.y.axis text').text("Temperature (\u00B0C)");


var doStuff = function(error, allData) {
	// when this is called we should have loaded the JSON from afar
	// or an error's occurred - handle that first
	if (error) {
		console.log(error);
		return;
	}
	// at this point, allData looks like (with other keys for pressure, precipitation etc.)
	// temp: {avg: [ [timestamp, data point], [timestamp, data point]] }
	// so we extract the list of timestamp/value pairs
	var data = allData.temp.avg.data;
	
	// set up an ordinal scale to colour the line
	color.domain(["Average"]);

	// ... and convert the timestamp into a JS Date object
	data.forEach(function(d) {
		d[0] = new Date(d[0]);
	});
	
	var tempData = color.domain().map(function(name) {
		return {
			name: name,
			values: data.map(function(d) {
				return {
					date: d[0],
					value: +d[1].toFixed(1),
					series: name
				};
			})
		};
	});

	
	var t0 = d3.select('.temp');
	if (!t0.select('g.grapharea').empty()) {
    	t0.select('g.grapharea').data(tempData);
    }
    else {
        svg.append("g")
		    .data(tempData)
    		.attr("class", "grapharea")
	    	.attr("clip-path", "url(#clip)");
	}
		updateTempChart(t0, d3.select('.temp'));
		
};


var update_data = function() {
	d3.timer(update_data, 5 * 60 * 1000);
    console.log("update_data fired at " + new Date().toString());
    // load the JSON data
    // and when that's finished, called the function defined in doStuff
    d3.json("http://weather.tolien.co.uk/day-data.json", doStuff);
    
    return true;
}
update_data();

function force_update() {
	update_data();
}

function old_force_update() {
	var points = d3.select('.temp').select('.temp');
	var data = points.data();
	var removed = data[0].values[0];

	// create a new Date object with time set to the leftmost point's time + 25 hours
	// (there's already a point at leftmost + 1 day, so this one should go in an hour after that)
	var cloneDate = new Date(removed.date.getTime() + 25 * 60 * 60 * 1000);
	// then push that onto the end, so we now have 25 hours worth of data

	data[0].values.push({
		date: cloneDate,
		value: removed.value,
		series: removed.series
	});
	
	var t0 = d3.select('.temp');
	t0.select('.temp').data(data);
	
	data[0].values.shift();


	updateTempChart(t0);
	d3.selectAll('.tooltip').remove();

	div = d3.select("body").append("div")
		.attr("class", "tooltip")
		.style("opacity", 0);
		
  return true;



}

		
   	  	    
	</script>
	
<input type="button" onclick="force_update()" value="Update" />
</body>

</html>
